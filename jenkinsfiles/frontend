pipeline {
    agent any

    environment {
        AWS_REGION   = "us-east-1"
        ACCOUNT_ID   = "730335658699"
        IMAGE_NAME   = "frontend"
        ECR_REPO     = "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${IMAGE_NAME}"
        GIT_REPO     = "microservices-jenkins-project"
        GIT_USER     = "YounesM22"
        GIT_EMAIL    = "younes@example.com"
        K8S_FILE     = "frontend.yaml"
    }

    stages {

        stage('Clean Workspace') {
            steps { cleanWs() }
        }

        stage('Checkout Source') {
            steps {
                git branch: 'main',
                    credentialsId: 'github-creds',
                    url: 'https://github.com/YounesM22/microservices-jenkins-project.git'
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('src/frontend') {
                    sh '''
                        docker system prune -f
                        docker build -t ${IMAGE_NAME}:latest .
                    '''
                }
            }
        }

        stage('Login & Push to ECR') {
            steps {
                sh '''
                    aws ecr get-login-password --region ${AWS_REGION} \
                    | docker login --username AWS --password-stdin ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

                    docker tag ${IMAGE_NAME}:latest ${ECR_REPO}:${BUILD_NUMBER}
                    docker push ${ECR_REPO}:${BUILD_NUMBER}
                '''
            }
        }

        stage('Update Kubernetes Manifest') {
    dir('kubernetes-files') {
        withCredentials([string(credentialsId: 'github-token', variable: 'GIT_TOKEN')]) {
            sh '''
            git config user.email "younes@example.com"
            git config user.name "YounesM22"

            sed -i 's#image:.*#image: 730335658699.dkr.ecr.us-east-1.amazonaws.com/frontend:1#g' frontend.yaml

            git add .
            if ! git diff --cached --quiet; then
              git commit -m "Update frontend image tag"
              git push https://$GIT_TOKEN@github.com/YounesM22/microservices-jenkins-project.git HEAD:main
            else
              echo "No changes to commit"
            fi
            '''
        }
    }
}

    }
}
